<!-- jshint ignore:start -->
{% extends 'homepage.html' %}

{% block content %}

{% if not user.is_authenticated or not user.is_instructor %}

<h3>User "{{user.kerb}}" is not authorized to access this page.</h3>

This is a bug, please report is to <a href="mailto:psetpartners@mit.edu">psetpartners@mit.edu</a>.

{% else %}

{% if user.is_admin %}

<p style="font-size:120%;"><b>{{classes[0].class_number}}&nbsp;{{classes[0].owner_name}}&nbsp;({{', '.join(classes[0].instructor_kerbs)}})</b> <a style="float:right; font-size:16px;" href="{{url_for('.admin')}}">index</a></p>

{% else %}

<h3>{{user.preferred_name}}</h3>

{% if classes|length == 0 %}
<p>You have reached this page because Touchstone has identified you as a non-student (affiliate, staff, or faculty) but you are not currently registered as an instructor on pset partners for a class that is offerred during the <b>{{current_term_pretty}}</b> term</p>
<ul class="faq">
<li>Instructors<p>If you are an instructor for a class this term, please accept our apologies for the inconvenience; the registration data provided to pset partners identifies only one responsible faculty member per class (even when the catolog lists multiple names).   Please contact the responsible faculty member for your course and ask them to add you as an instructor.  If you do not know who that is, or if it should be you, please <a href="mailto:psetpartners@mit.edu">contact us</a>.</p></li>

<li>Students<p>If you reached this page it is because Touchstone identified you in a differerent role &mdash; this occaasionally happes to special students and/or cross-registered students.  Please <a href="mailto:psetpartners@mit.edu">contact us</a> so that we can update your pset partners profile.  In your eamil please include your name, kerberos identifier, and at least one subject number of a course you are registered for this term.</p></li>

<li>Staff and affiliates<p>The pset partners website is only available to students and instructors, but please feel free to explore our <a href="https://psetpartners-test.mit.edu">test site</a> or browse our <a href="{{url_for('.faq')}}">FAQ</a>.
</ul>
{% else %}
{% set inactive = classes|selectattr("active","false")|list %}
{% if inactive %}
<p align="justify">According to our records, you are the responsible faculty member for the following classes which are <b>not currently active</b> on pset partners:</p>
<ul class="classlist">
{% for c in inactive %}
<li>{{ ' / '.join(c['class_numbers']) + ' ' + c['class_name']  }}<button type="button" class="confirm" id="activate-{{c['id']}}" value="{{c['id']}}" onclick="location.href='{{url_for('.activate',class_id=c['id'])}}';">activate</button></li>
{% endfor %}
</ul>
{% endif %}

{% set active=classes|selectattr("active")|list %}
{% if active %}
{% if active|length == 1 %}
<p align="justify">According to our records, you are teaching <b>{{ ' / '.join(classes[0]['class_numbers']) + " " + classes[0]['class_name']}}</b>.</p>
{% else %}
<p>According to our records, you are teaching the following classes this term:</p>
<ul class="classlist">
{% for i in range(active|length) %}
{% set c = classes[i] %}
<li> <label class="clickable" onclick="toggleClass({{i}});">{{ ' / '.join(c['class_numbers']) + ' ' + c['class_name']  }}</label></li>
{% endfor %}
</ul>
{% endif %}
{% endif %}
{% endif %}
{% endif %}

{% if active|length %}
<p>
The table below lists the <label class="highlight" id="students">?</label> students and <label class="highlight" id="groups">?</label> groups in <label class="highlight" id="class_number">?</label> using pset partners during the <b>{{current_term_pretty}}</b> term.
</p>
<h3 style="text-align:center;" id="student-table-heading">?</h3>

<table class="mtab" id="student-table">
  <thead><tr>
    <th id="name" class="sortable">name</th>
    <th id="depts" class="sortable">depts</th>
    <th id="year" class="sortable">year</th>
    <th id="email" class="sortable">email</th>
    <th id="group" class="sortable">group</th>
    <th id="visibility" class="sortable">type</th>
  </tr></thead>
  <tbody id="student-rows"></tbody>
</table>

{% endif %}

<script>
// jshint ignore:start
const isLive = {{ livesite|tojson|safe }};
const classes = {{ classes|tojson|safe }};
const toggles = {{ user.toggles|tojson|safe }};
// jshint ignore:end
/* global classes, toggles, isLive */

let loaded = false;
let classIndex = 0;
let classSort = [];
let classRows = [];

const visibilityPretty = ['invitation', 'permission', 'automatic', 'public']
const statusPretty = ['no action', 'member', 'in pool', 'match requested', 'matching', 'matching'];

// student_row_cols = [ 'full_name', 'preferred_name', 'preferred_pronouns', 'departments', 'year', 'kerb', 'status',
//                      'group_name', 'visibility', 'size', 'max']

function formatRow(s) {
  return {
    kerb: s[5],
    name: s[0] || s[1] || s[5],
    depts: s[3],
    year:  s[4] == '5' ? 'G' : (s[4]||'-'),
    email: s[5],
    group: s[7],
    status: parseInt(s[6]||'0'),
    visibility: parseInt(s[8]||'0'),
    full: s[10] ? parseInt(s[10]) <= parseInt(s[9]||'0') : false,
  };
}

function renderRows() {
  date = classes[classIndex].next_match_date;
  return classRows[classIndex].map(row => `<tr>
    <td style="text-align:left;">${row.name}</td>
    <td>${row.depts.split(' ').join(', ')}</td>
    <td>${row.year}</td>
    <td style="text-align:right;"><a href="mailto:${row.email}@mit.edu">  ${row.email}@mit.edu</a></td>
    <td style="text-align:left;${row.group ? '' : 'font-style:italic; font-size:90%; color:#555;'}">${row.group||('&nbsp;&nbsp;'+statusPretty[row.status])+(row.status==2?' for '+date:'')}</td>
    <td style="text-align:left;">${row.group ? visibilityPretty[row.visibility] + (row.full?' (full)':'') : ''}</td>
   </tr>`).join('');
}

function toggleClass(i) {
  if ( i < 0 ) i = 0;
  $('#students').html(''+classRows[i].length);
  $('#groups').html(''+classes[i].groups);
  $('#class_number').html(''+classes[i].class_number);
  $('#match-date').html(classes[i].next_match_date);
  $('#student-table-heading').html(classes[i].class_number + ' ' + classes[i].class_name);
  $('#student-rows').html(renderRows(classRows[i]));
  classIndex = i;
  ajaxToggle('ct', classes[i].class_number);
  showStudentTable();
}

function headerClick (e) {
  classSort[classIndex].curCol = e.target.id;
  classSort[classIndex].dir = classSort[classIndex].curCol == classSort[classIndex].prevCol ? -classSort[classIndex].dir : 1;
  ajaxToggle('st-'+classes[classIndex].class_number, (classSort[classIndex].dir < 0 ? '-' : '+') +e.target.id);
  showStudentTable();
}

function colCompare(a,b,col,dir)
{
  if ( a[col] == b[col] ) {
    if (col == 'depts' ) return colCompare(a,b,'year',dir)
    if (col == 'visibility') return colCompare(a,b,'full',dir);
    if (col == 'full') return colCompare(a,b,'group',dir);
    if (col == 'group') return colCompare(a,b,'status',dir)
    if (col == 'name' ) return colCompare(a,b,'kerb',dir)

  }
  return a[col] < b[col] ? -dir : dir;
}

function showStudentTable () {
  const dir = classSort[classIndex].dir;
  const col = classSort[classIndex].curCol;
  classRows[classIndex].sort(function(a,b) { return colCompare(a,b,col,dir); });
  classSort[classIndex].prevCol = col;
  $('#student-rows').html(renderRows());
  const q = $('#student-table th.active');  q.removeClass('asc'); q.removeClass('desc'); q.removeClass('active');
  $('#'+col).addClass('active');  $('#'+col).addClass(dir>0 ? 'asc' : 'desc');
}

function ajaxToggle(name, value) {
  if ( ! loaded ) return false;
  ajaxToggle[name] = value;
  if ( ajaxToggle[name+'Pending'] ) return false;
  ajaxToggle[name+'Pending'] = true;
  window.setTimeout(function(){
    $.ajax({url: '/_toggle', data: { 'name': name, 'value': ajaxToggle[name] }});
    ajaxToggle[name+'Pending'] = false;
    }, 500);
  return true;
}

document.addEventListener('DOMContentLoaded', function() {
  for (let i = 0 ; i < classes.length ; i++ ) {
    const c = classes[i].class_number,  t = toggles['st-'+c] || '+name';
    classSort[i] = { curCol: t.slice(1), prevCol: '', dir: t[0] == '-' ? -1 : 1 };
    classRows[i] = classes[i].students.map(formatRow);
  }
  $('#student-table th').click(headerClick);
  if ( toggles.ct && classes.length ) toggleClass(classes.findIndex(x => x.class_number == toggles.ct));
  else toggleClass(0);
  loaded = true;
  console.log(isLive ? "We are live!" : "We are in the sandbox.");
});

</script>
{% endif %}

{% endblock %}
