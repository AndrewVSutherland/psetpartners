<!-- jshint ignore:start -->
{% extends 'homepage.html' %}

{% block content %}

{% if not user.is_authenticated %}

<h3>User "{{user.kerb}}" not authenticated.</h3>

This is a bug, please report is to <a href="mailto:psetpartners@mit.edu">psetpartners@mit.edu</a>.

{% else %}

  <form action="{{ url_for('.save_student') }}" method="post" name="student" id="student" onsubmit="return submitStudentForm(this.submitted);">

  <h3>Personal profile</h3>

  <table class="input">
    <tr>
      <td class="caption">Preferred name</td>
      <td class="value"><input class="value" spellcheck="false" name="preferred_name" id="preferred_name" value="{{user.preferred_name}}" tabindex="1" placeholder="this is required" required maxlength="{{maxlength['preferred_name']}}" 
       oninput="$('#preferred_name_info').html(this.value?'required':'<b style=&quot;color:var(--alert-color);&quot;>required</b>');"/></td>
      <td class="forminfo">required</td>
    </tr>
    <tr>
      <td class="caption">Preferred pronouns</td>
      <td class="value"><input class="value" spellcheck="false" name="preferred_pronouns" id="preferred_pronouns" value="{{user.preferred_pronouns}}" tabindex="2" placeholder="e.g. he/him, she/her, they/them" maxlength="{{maxlength['preferred_pronouns']}}" /></td>
    <td class="forminfo">optional</td>
    </tr>
    <tr>
      <td class="caption">Homepage</td>
      <td class="value"><input class="value" spellcheck="false" name="homepage" id="homepage" value="{{user.homepage}}" tabindex="3" placeholder="e.g. https://www.mit.edu/~johndoe/" maxlength="{{maxlength['homepage']}}"
        oninput="$('#homepage_info').html(validURL(this.value)?'optional':'<b style=&quot;color:var(--alert-color);&quot;>invalid URL</b>');" /></td>
      <td class="forminfo" id="homepage_info">optional</td>
    </tr>
    <tr>
      <td class="caption">Department(s)</td>
      <td class="value">
        <span class="select" id="select-departments" tabindex="4"></span>
        <input type="hidden" name="departments" id="departments" value="{{user.departments}}" />
      </td>
      <td class="forminfo" id="departments_info">optional</td>
    </tr>
    <tr>
      <td class="caption">Current year</td>
      <td class="value">
        <span class="select" id="select-year" tabindex="5"></span>
        <input type="hidden" name="year" id="year" value="{{user.year|blanknone}}"/>
      </td>
    <td class="forminfo">optional</td>
    </tr>
    <tr>
      <td class="caption">Gender identity</td>
      <td class="value">
        <span class="select" id="select-gender" tabindex="6"></span>
        <input type="hidden" name="gender" id="gender" value="{{user.gender|blanknone}}"/>
      </td>
    <td class="forminfo">optional</td>
    </tr>
    {#
    <tr>
      <td class="caption" style="vertical-align:top; padding-top:7px;">About me</td>
      <td><textarea class="value" name="description" tabindex="7"  placeholder="A fun fact or something you would like your pset partners to know about you." rows="4" maxlength="{{maxlength['description']}}">{{user.description}}</textarea></td>
    </tr>
    #}
  </table>

  <h3>Profile for the {{current_upcoming}} term ({{current_term_pretty}})</h3>
  <table class="input" style="margin-bottom:0px;">
    <tr>
      <td class="caption">Location</td>
      <td class="value">
        <span class="select" id="select-location" tabindex="8"></span>
        <input type="hidden" name="location" id="location" value="{{user.location}}"/>
      </td>
      <td class="forminfo">required</td>
    </tr>
    <tr>
      <td class="caption">Time zone</td>
      <td class="value">
        <span class="select" id="select-timezone" tabindex="9"></span>
        <input type="hidden" name="timezone" id="timezone" value="{{user.timezone}}" onchange="showTimezoneOffset()"/>
      </td>
      <td class="forminfo">required</td>
    </tr>
    <tr>
      <td class="caption">Classes</td>
      <td class="value">
        <span class="select" id="select-classes" tabindex="10"></span>
        <input type="hidden" name="classes" id="classes" value="{{user.classes}}" onchange="changeClasses(this.value)"/>
      </td>
      <td class="forminfo">optional</td>
    </tr>
    <tr><td class="caption" colspan="3" style="padding-top:10px;"><label id="tzcaption">Times available for collaboration (in your time zone)</label></td></tr>
  </table>
  <br>
  <table class="cbg" id="hours" style="margin-left:60px; margin-top:-10px; margin-bottom:-5px;" onclick="$('#hours-compatible').focus()">
    <tr class="cbg">
      {% for i in range(24) %}
        <td class="cbg cbgt">{{i}}</td>
      {% endfor %}
      <td></td>
    </tr>
    {% for i in range(7) %}
    <tr class="checkboxgrid">
      {% for j in range(24) %}
      <td class="cbg"><label class="cbg">
          <input class="cbg" name="hours-{{i}}-{{j}}" id="cb-hours-{{i}}-{{j}}" type="checkbox" {% if user.hours[24*i+j] %}checked{% endif %} />
          <span id="hours-{{i}}-{{j}}" class="cbg"></span>
      </label></td>
      {% endfor %}
      <td class="cbg cbgr">{{options.weekday[i]}}</td>
    </tr>
    {% endfor %}
  </table>
  <div style="text-align:center"><span class="formcaption" id="hours-compatible" tabindex="11"></span></div>

  <div class="htoggler" tabindex="12">
    <label class="htoggler-nav htoggler-active" id="pref-header">Preferences</label>
    <label class="htoggler-after"></label>
    <label class="htoggler-nav" id="group-header">Groups</label>
  </div>
  <div style="clear:both;"></div>

   <div class="toggler" id="pref-toggler" tabindex="13">
    {% for i in  range(maxlength["classes"]+1) %}
      <div class="toggler-nav {% if not i %}toggle-active{% endif %}" id="toggle-{{i}}" {% if i > user.classes|length %} style="display:none;"{% endif%}>
        {{"General" if i == 0 else (user.classes[i-1] if i and i <= user.classes|length else "")}}
      </div>
    {% endfor %}
  </div>

{% set smax = options["strength"]|length -1 %}

{% macro PREF(caption, pref, tabindex, start) -%}
{% set start = start|default(0) %}
{% set n = user.classes|length + 1 %}
{% for i in range(start,maxlength["classes"]+1) %}
  {% set pval = user.class_data[user.classes[i-1]].preferences[pref] if i and i < n else user.preferences[pref] %}
  {% set sval = 3 if not pval else (user.class_data[user.classes[i-1]].strengths[pref] if i and i < n else user.strengths[pref]) %}
  <tr class="toggle-{{i}} pref-{{pref}}" style="display:none;">
    <td class="caption"><label class="pref-{{pref}}">{{caption}}</label></td>
    <td class="value pref-{{pref}}">
      <span class="select" id="select-pref-{{pref}}-{{i}}" tabindex="{{tabindex}}"></span>
      <input type="hidden" name="pref-{{pref}}-{{i}}" id="pref-{{pref}}-{{i}}" value="{{pval|blanknone}}" onchange="showPS(this.name,this.value)"/>
    </td>
    <td class="pref-{{pref}}" style="padding-left:10px;">
      <input class="slider" name="spref-{{pref}}-{{i}}" id="spref-{{pref}}-{{i}}" tabindex="{{tabindex+1}}" type="range" min="1" max="5" value="{{sval}}" oninput="showPSL(this.name,this.value)"{% if not pval %} style="display:none;"{% endif %} />
      <label class="strength" id="lspref-{{pref}}-{{i}}">{{options.strength[sval if pval else 0]}}</label>
    </td>
  </tr>
{% endfor %}
{%- endmacro %}

{% macro CPROP(caption, prop, tabindex) -%}
{% set n = user.classes|length + 1 %}
  {% for i in range(1,maxlength["classes"]+1) %}
    {% set pval = user.class_data[user.classes[i-1]].properties[prop] if i < n else "" %}
    <tr class="toggle-{{i}}" style="display:none;">
      <td class="caption"><label>{{caption}}</label></td>
      <td class="value">
        <span class="select" id="select-{{prop}}-{{i}}" tabindex="{{tabindex}}"></span>
        <input type="hidden" name="{{prop}}-{{i}}" id="{{prop}}-{{i}}" value="{{pval|blanknone}}"/>
      </td>
      <td class="forminfo">optional</td>
    </tr>
  {% endfor %}
{%- endmacro %}

  <table class="input pref">

    {{PREF("When you like to start working", "start", 14)}}
    {{PREF("How you like to collaborate", "together", 16)}}
    {{PREF("How you like to communicate", "forum", 18)}}
    {{PREF("Your ideal group size", "size", 20)}}
    {{CPROP("Commitment to this course", "commitment", 21)}}
    {{CPROP("Knowledge of the material", "confidence", 22)}}

    <tr style="display:none; height:5px;" id="affinity-separator"><td colspan="3"></td></tr>

    {{PREF("", "departments_affinity", 23)}}
    {{PREF("", "year_affinity", 25)}}
    {{PREF("", "gender_affinity", 27)}}
    {{PREF("", "commitment_affinity", 29, 1)}}
    {{PREF("", "confidence_affinity", 31, 1)}}
 
  </table>

  <div class="group" style="display:none;">

  {% set n = user.classes|length + 1 %}
  {% for i in range(maxlength["classes"]+1) %}
    <div style="width: 100%; padding:0 20px;{{'display:none;' if i else ''}}" class="toggle-{{i}}">
      <p id="group-summary-{{i}}"></p>
      <p id="group-instructions-{{i}}"></p>
    </div>
  {% endfor %}

  </div>

  <input class="ctx" type="hidden" name="ctx-scrollTop" value="" />
  <input class="ctx" type="hidden" name="ctx-currentClass" value="" />
  <input class="ctx" type="hidden" name="ctx-htogglerId" value="" />

  <div style="display:inline-block;">
  <table class="submit">
    <tr>
      <td><button type="submit" name="submit" id="save" value="save" tabindex="-1" onclick="this.form.submitted=this.value;" disabled>Save</button></td>
      <td><button type="submit" name="submit" id="cancel" value="cancel" tabindex="-1" onclick="this.form.submitted=this.value;" disabled>Reset</button></td>
      <td><label class="alertinfo" id="submit_alert"></label></td>
    </tr>
  </table>
</div>
<div style="display:inline-block; float:right;">
<table class="submit">
  <tr><td>
  <button class="confirm" id="apply-prefs" tabindex="-1" onclick="applyPreferences(); return false;" style="display:none;">Apply to all classes</button><label class="confirm" id="apply-prefs-confirm" style="display:none;">Applied! (but not saved)</label>
</td></tr>
</table></div>
  </form>

<!-- jshint ignore:end -->
<script>

// jshint ignore:start
const classesOptions = [
{% for val, option in options.classes %}
  { value: '{{val}}', label: '{{val}} {{option}}' },
{% endfor %}
];

const timezoneOptions = [
{% for val, option in options.timezones %}
  { value: '{{val}}', label: '{{option}}' },
{% endfor %}
];

var allCounts = {{ counts|tojson|safe }};

const maxlength = {{ maxlength|tojson|safe }};
const ctx = {{ ctx|tojson|safe }};

// jshint ignore:end

/* global classesOptions, timezoneOptions, allCounts, maxlength, ctx */ // from template (ignored above)
/* global studentOptions, studentPlaceholders, studentPreferences, studentClassPreferences, studentAffinities, studentClassAffinities */ // options.js
/* global makeSingleSelect, updateSingleSelect, makeMultiSelect, validURL, makeCheckboxGrid */ // in psetpartners.js

function classLabel(v) { return classesOptions.find(x => x.value == v).label; }

const strengthOptions = [{% for s in options["strength"] %} "{{s}}", {% endfor %}]; // jshint ignore: line

/* userClasses acts as an associative array indexed by class_number into user.class_data */
let studentClasses = [ {% for class_number in user.classes %} "{{class_number}}", {% endfor %} ];  // jshint ignore: line

function showTimezoneOffset() {
  const tz = document.getElementById('timezone').value;
  const tzopt = timezoneOptions.find(x => x.value==tz);
  const caption = ( tzopt && tzopt.label.includes(')') ) ?
    "Times available for collaboration (in your time zone, which is currently " + tzopt.label.split(')')[0].substr(1) +')' :
    "Times available for collaboration (MIT time)";
  $('#tzcaption').text(caption);
}

function showPS(id, val) {
  const e = document.getElementById('s'+id);
  e.style.display = val ? 'inline-block' : 'none';
  showPSL('s'+id, val ? (e.value?e.value:3) : 0);
}

function showPSL(id, val) {
  document.getElementById('l'+id).innerHTML = strengthOptions[val];
}

function getPrefs(prefs,i) {
  let res = {};
  for ( const pref of prefs ) {
    const id = 'pref-' + pref + '-' + i;
    res[pref] = { value: document.getElementById(id).value, strength: document.getElementById('s'+id).value };
  }
  return res;
}

function getProps(props,i) {
  let res = {};
  for ( const prop of props ) {
    const id = prop + '-' + i;
    res[prop] = document.getElementById(id).value;
  }
  return res;
}

function prefNotes(pref, counts) { return counts ? (pref.endsWith("_affinity") ? null : counts[pref]) : null; }

function setPrefs(prefs, i, counts) {
  for ( const p in prefs ) {
    const id = 'pref-' + p + '-' + i;
    const e = document.getElementById(id), s = jQuery(e).data('select');
    e.value = prefs[p].value;
    const notes = prefNotes (p, counts);
    if ( ! s ) makeSingleSelect(id, studentOptions[p], { placeholder: studentPlaceholders[p], notes: notes }); else updateSingleSelect (id, notes);
    document.getElementById('s'+id).value = prefs[p].strength;
    showPS(id, e.value);
  }
}

function setProps(props, i, counts) {
  for ( const p in props ) {
    const id = p + '-' + i;
    const e = document.getElementById(id), s = jQuery(e).data('select');
    e.value = props[p];
    const notes = prefNotes (p, counts);
    if ( ! s ) makeSingleSelect(id, studentOptions[p], { placeholder: studentPlaceholders[p], notes: notes }); else updateSingleSelect(id, notes);
  }
}

function addChosenBy(cnts) { for (let c in cnts) for (let k in cnts[c]) if ( typeof(cnts[c][k]) === 'object' && '' in cnts[c][k] ) cnts[c][k][''] = 'chosen by ' + cnts[c][k]['']; }

function changeClasses(val) {
  let v = typeof(val) == "string" ? val.split(',') : val;
  v = v.map(x => x.trim()).filter(x => x !== '');

  const vnew = v.filter(x => ! (x in allCounts)).join(",");
  function updateCounts(r) {
    addChosenBy(r.counts);
    for (let c in r.counts) {
      allCounts[c] = r.counts[c];
      if ( c ) { const i = studentClasses.indexOf(c); setPrefs(classesPrefs[c], i+1, allCounts[c]); setProps(classesProps[c], i+1, allCounts[c]); }
    }
  }
  if ( vnew.length ) $.ajax({url: '/_counts', data: {'classes': vnew}, dataType: 'json', success: updateCounts });

  let classesPrefs = {}, classesProps = {};

  let allPreferences = [...studentPreferences, ...studentClassPreferences];
  for ( let i = 0 ; i < studentClasses.length ; i++ ) {
    const c = studentClasses[i];
    if ( v.includes(c) ) {
      classesPrefs[c] = getPrefs(allPreferences, i+1);
      classesProps[c] = getProps(studentClassAffinities, i+1);
    }
  }
  let defaultPrefs = getPrefs(studentPreferences, 0);
  for ( const pref of studentClassPreferences ) defaultPrefs[pref] = { value: '', strength: 3 };
  for ( const c of v ) if ( ! (c in classesPrefs) ) classesPrefs[c] = defaultPrefs;
  let defaultProps = {};
  for ( const prop of studentClassAffinities ) defaultProps[prop] = '';
  for ( const c of v ) if ( ! (c in classesProps) ) classesProps[c] = defaultProps;
  for ( let i = 0 ; i < v.length ; i++ ) {
    const c = v[i];
    if ( c != studentClasses[i] ) {
      setPrefs(classesPrefs[c], i+1, allCounts[c]);
      setProps(classesProps[c], i+1, allCounts[c]);
      const q = $('#toggle-'+(i+1)); q.html(c); q.show();
    }
  }
  for ( let i = v.length ; i < studentClasses.length ; i++ ) { const q = $('#pref-'+(i+1)); q.html(''); q.hide(); }
  const i = togglerIndex();
  const c = i ? studentClasses[i-1] : '';
  studentClasses = [...v];
  if ( c ) {
    const j = studentClasses.indexOf(c);
    if ( j >= 0 ) togglerIndex(j+1); else togglerIndex(i <= studentClasses.length ? i : i-1);
  } else {
    togglerIndex(0);
  }
  setGroupPanes();
}

function setGroupPanes() {
  let cnts = allCounts[''];
  $('#group-summary-0').text(
    `There are currently ${cnts.students} students, ${cnts.classes} classes, and ${cnts.groups} groups listed on pset partners, of which ${cnts.visibility['2']} are public.`
  );
  if ( studentClasses.length ) {
    $('#group-instructions-0').text('Click on a class number to see your pset partnering options for that class.');
  } else {
    $('#group-instructions-0').text('Add one or more classes in order see information about how to join a pset group.');
  }
  for ( let i = 0 ; i < studentClasses.length ; i++ ) {
    const c = studentClasses[i];
    if ( c in allCounts ) {
      const s = allCounts[c].students, g = allCounts[c].groups, sg = allCounts[c].students_groups;
      let v = ['0', '0', '0'];
      for (let i = 0 ; i <= 2 ; i++ ) if ( (''+i) in allCounts[c].visibility ) v[i] = allCounts[c].visibility[''+i];
      let msg = `There are ${s} students in ${c} registered on pset partners.`;
      if ( g ) {
        msg += ` Currently ${sg} of these student are memebers of one of the ${g} pset groups that have formed in this class.`;
        if ( sg+1 < s ) msg += ` That means ${s-sg} students may currently be looking for pset partners!`;
        msg += '<br><br>';
        msg += `Of the ${g} pset groups in this class, ${v[2]} are public, ${v[1]} are private but open to new members, and ${v[0]} are closed to new members.`;
      } else {
        msg += `No pset groups have been formed for this class yet, all ${s} students are looking for pset partners!`;
      }
      $('#group-summary-'+(i+1)).html(msg);
    } else {
      $('#group-summary-'+(i+1)).text(`Group data not yet retrieved for ${c}, click save to update.`);
    }
  }
}

function showApplyPreferences() {
  if ( typeof (showApplyPreferences.snapshot) == 'undefined' ) {
    showApplyPreferences.snapshot = JSON.stringify(getPrefs(studentPreferences,0));
    $('#apply-prefs').hide();
  }
  if ( togglerIndex() === 0 && JSON.stringify(getPrefs(studentPreferences,0)) != showApplyPreferences.snapshot ) {
    $('#apply-prefs').show();
  } else { 
    $('#apply-prefs').hide();
  }    
}

function applyPreferences() {
  const prefs = getPrefs(studentPreferences,0);
  for ( let i = 0 ; i < studentClasses.length ; i++ ) setPrefs(prefs, i+1);
  showApplyPreferences.snapshot = JSON.stringify(getPrefs(studentPreferences,0));
  $('#apply-prefs').hide(); $('#apply-prefs-confirm').show(); $('#apply-prefs-confirm').fadeOut(3000);
}

function htogglerMakeActive(e) {
    if ( e.classList.contains('htoggler-active') ) return;
    $('.htoggler-active').removeClass('htoggler-active');
    e.classList.add("htoggler-active");
    if ( e.id === "pref-header" ) { console.log("pref"); $('.group').hide(); $('.pref').show(); }
    if ( e.id === "group-header" ) { console.log("group"); $('.pref').hide(); $('.group').show(); }
}

function togglerIndex(i) {
  if ( typeof i === 'undefined'  ) {
    const id = $('.toggler-nav.toggler-active').attr('id');
    return id ? parseInt(id.split('-')[1]) : null;
  }
  const id = 'toggle-' + i;
  const oldid = $('.toggler-nav.toggler-active').attr('id');
  if ( id === oldid ) return;
  $('.htoggler-after').html(i > 0 ? 'for ' + classLabel(studentClasses[i-1]) : '');
  $('.' + oldid).hide();  $('.'+id).show();
  $('#'+oldid).removeClass('toggler-active');
  $('#'+id).addClass('toggler-active');
  showAffinityPreferences();
  showApplyPreferences();
  computeHoursCompatible();
}

function togglerCaption() {
  return $('.toggler-nav.toggler-active').text().trim();
}

function saveErrorMessage() {
  if ( document.getElementById('preferred_name').value.trim() === '' )
    return 'Please enter your preferred name.';
  if ( $('#hours input:checkbox:checked').length < 6 )
    return 'Please select at least 6 hours when you are available to collaborate.';
  if ( ! validURL(document.getElementById('homepage').value) )
    return 'Please correct or delete the invalid URL listed for your homepage.';
  return '';
}

function showSaveErrorMessage() {
  const msg = saveErrorMessage();
  if ( msg ) $('#save').prop('disabled',true);
  document.getElementById('submit_alert').innerText = msg;
}

function showAffinityPreferences() {
  let caption = false;
  const i = togglerIndex();
  const affinities = i ? [...studentAffinities, ...studentClassAffinities] : studentAffinities;
  for ( let x of affinities ) {
    const val = document.getElementById(x + (studentClassAffinities.includes(x) ? '-' + i : '')).value;
    const a = x + '_affinity', qv = '.pref-' + a + '.pref-' + i, qc = 'label.pref-' + a;
    $(qc).text(""); 
    if ( val === '' || val === '[]' ) {
      $(qv).hide();
    } else {
      $(qv).show(); if ( ! caption ) { $(qc).text("Your ideal group would include"); caption = true; }
    }
  }
  document.getElementById('affinity-separator').style.display = caption ? 'inline-block' : 'none';
}

var currentOverlap = 0;
var currentCounts = allCounts[''];

function hoursOffset() {
  const tz = $('#timezone').val();
  if ( tz === 'MIT' ) return 0;
  const t = timezoneOptions.find(x => x.value === tz);
  let n = parseInt(t.label.substring(4,7));
  if ( parseInt(t.label.substring(8,10)) > 30 ) n = n < 0 ? n-1 : n+1;
  return n;
}

function showHoursCompatible() {
  let c = togglerCaption();  if ( c == 'General' ) c = 'all';
  $('#hours-compatible').text('Average overlap: ' + (currentOverlap/currentCounts.students).toFixed(2) + ' hours (' + c + ' students)');
}

function computeHoursCompatible() {
  const offset = hoursOffset();
  currentOverlap = 0;
  let cur = togglerCaption();
  currentCounts = allCounts[cur === 'General' ? '' : cur];
  if ( ! currentCounts ) { $('#hours-compatible').text(''); return; } // if ajax response is slow, we might not have counts
  const hours = currentCounts.hours;
  for ( let i = 0 ; i < 7 ; i++ ) for ( let j = 0 ; j < 24 ; j++ ) {
    const n = (24*i+j+168-offset)%168;
    if ( document.getElementById('cb-hours-' + i + '-' + j).checked ) currentOverlap += hours[(24*i+j+168-offset)%168];
  }
  showHoursCompatible();
}

function updateHoursCompatible(e) {
  if ( ! currentCounts ) return;
  const x = e.id.split('-');
  if ( x.length != 4 ) return;
  const i = parseInt(x[2]), j = parseInt(x[3]);
  const n = currentCounts.hours[(24*i+j+168-hoursOffset())%168];
  currentOverlap += (e.checked ? 1 : -1 ) * n;
  showHoursCompatible();
}

function checkChanges (e) {
  if ( ! e.target.name ) return;
  console.log (e.target.name + ' changed to ' + (e.target.type === 'checkbox' ? e.target.checked : e.target.value));
  const change = $('#student').serialize() != $('#student').data('initial');
  $('#student :submit').prop('disabled',!change);
  showSaveErrorMessage();
  if ( studentAffinities.find(x => x === e.target.name) || studentClassAffinities.find(x => x === e.target.name.split('-')[0]) ) showAffinityPreferences();
  if ( e.target.classList.contains('pref-0') ) showApplyPreferences();
  if ( e.target.name === 'timezone' ) computeHoursCompatible();
  if ( e.target.name.startsWith('hours-') ) updateHoursCompatible(e.target);
}

function submitStudentForm (value) {
  $('input[name="ctx-scrollTop"]').val($(window).scrollTop());
  const i = togglerIndex();
  $('input[name="ctx-currentClass"]').val(i?studentClasses[i-1]:'');
  $('input[name="ctx-htogglerId"]').val($(".htoggler-active").attr('id'));
  if ( value === "cancel" ) { $('input:not(.ctx)').attr('name',''); return true; }
  for ( let i = studentClasses.length+1 ; i <= maxlength.classes ; i++ ) $('input.pref-'+i+', .prop-'+i).attr('name','');
  return true;
}

function alertInfo(q,msg) {
  const content = $(q).html();
  $(q).html('<b style="color:var(--alert-color);">' + msg + '</b>'); $(q).fadeOut(3000, function() { $(q).html(content).show(); });
}

function ajaxErrorHandler(xmlhttpreq, textstatus, message) {
  console.log(`ajacErrorHandler called for URL="${this.url}", textstatus="${textstatus}", message="${message}`);
}

document.addEventListener('DOMContentLoaded', function() {
  function classesLimit (n) { alertInfo('#classes_info', 'At most ' + maxlength.classes + ' classes permitted!'); }
  function departmentsLimit (n) { alertInfo('#departments_info', 'At most ' + maxlength.departments + ' departments permitted!'); }

  $.ajaxSetup({error:ajaxErrorHandler}); // use this rather than ajexError so "this" is defined
  addChosenBy(allCounts);

  makeMultiSelect('departments', 
    studentOptions.departments,
    { placeholder: studentPlaceholders.departments, limit: maxlength.departments, onLimit: departmentsLimit}
  );
  makeMultiSelect('classes',
    classesOptions,
    { placeholder: studentPlaceholders.classes, shortTags: true, limit: maxlength.classes, onLimit: classesLimit }
  );
  if ( ! $('#timezone').val() ) {
    let tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if ( tz == "America/New_York" || tz == "US/Eastern" ) tz = "MIT";
    $('#timezone').val(tz);
    if ( tz != "MIT" && ! $('#location').val() ) $('#location').val('far');
  }
  makeSingleSelect('location', studentOptions.location, {});
  makeSingleSelect('timezone', timezoneOptions, {});
  const sp = studentPlaceholders;
  makeSingleSelect('year', studentOptions.year, { placeholder: sp.year });
  makeSingleSelect('gender', studentOptions.gender, { placeholder: sp.gender });
  for (const pref of studentPreferences) {
    for ( let i = 0 ; i <= studentClasses.length ; i++ )
      makeSingleSelect('pref-' + pref + '-' + i, studentOptions[pref], { placeholder: sp[pref], notes: prefNotes(pref, allCounts[i?studentClasses[i-1]:'']) });
  }
  for (const pref of studentClassPreferences) {
    for ( let i = 1 ; i <= studentClasses.length ; i++ )
      makeSingleSelect('pref-' + pref + '-' + i, studentOptions[pref], { placeholder: sp[pref] });
  }
  for (const prop of studentClassAffinities) {
    for ( let i = 1 ; i <= studentClasses.length ; i++ )
      makeSingleSelect(prop + '-' + i, studentOptions[prop], { placeholder: sp[prop], notes: prefNotes(prop, allCounts[i?studentClasses[i-1]:'']) });
  }
  makeCheckboxGrid();
  showTimezoneOffset();
  showSaveErrorMessage();
  setGroupPanes();

  $('input:text').attr('autocomplete','off');

  $('.htoggler-nav').click(function(e) { e.preventDefault(); htogglerMakeActive(e.target); return false; });
  $('.toggler-nav').click(function(e) { e.preventDefault(); togglerIndex(parseInt(e.target.id.split('-')[1])); return false; });
  togglerIndex(0);

  $('input[name="classes"]').data('initial',$('input[name="classes"]').val());
  $('#student').data('initial',$('#student').serialize());
  $('#student :input').change(checkChanges);
  $('#student :text').keyup(checkChanges);  /* this is overkill but the only way to catch all changes in real time */

  $('.htoggler').keydown(function(e){
    if ( e.which === 37 || e.which === 39 ) {
      htogglerMakeActive(document.getElementById($('.htoggler-active').attr('id') === 'pref-header' ? 'group-header' : 'pref-header'));
    }
  });
  $('.toggler-nav').focusin(function(e){ if ( ! e.target.classList.contains('htoggler-active') ) { $('.htoggler-nav.htoggler-active').focus(); }});
  $('.toggler').keydown(function(e){
    if ( e.which === 37 || e.which === 39 ) {
      const n = studentClasses.length+1;
      const id =  $('.toggler-active').attr('id');
      togglerIndex((parseInt(id.split('-')[1]) + e.which - 38 + n) % n);
    }
  });
  $('.toggler-nav').focusin(function(e){ if ( ! e.target.classList.contains('toggler-active') ) { $('.toggler-active').focus(); }});
  if ( ctx.currentClass ) togglerIndex(studentClasses.indexOf(ctx.currentClass)+1);
  if ( ctx.scrollTop ) window.setTimeout(function() { $(window).scrollTop(ctx.scrollTop); }, 0);
  if ( ctx.htogglerId ) htogglerMakeActive(document.getElementById(ctx.htogglerId));

  showAffinityPreferences();
  showApplyPreferences();
  computeHoursCompatible();
  console.log('student page ready');
});
</script>

{% endif %}

{% endblock %}
